---
title: "Anadromous salmonids in GJE"
author: "EEG"
date: "2022-10-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r, echo=FALSE}
library(here)
library(readr)
library(magrittr)
library(dplyr)
library(ggplot2)
library(cowplot)
library(ggpubr)
library(gridExtra)
library(tidyr)
library(leaflet)
library(mapview)
library(mgcv)
library(scales)
library(agricolae)
library(tibble)
library(plotly)
Sys.setlocale(locale='no_NB.utf8')
Sys.getlocale()
#remotes::install_github("r-spatial/mapview")

```


# Read meta data files
```{r}

samples_meta <- readxl::read_xlsx(here("data", "eDNAsamples_GJE_2021_Rform.xlsx")) %>% 
  mutate(sampl_replicate = as.factor(sampl_replicate))

```

# Read QA pcrd-files in one go
```{r}
speciespath <- paste0("export_pcrd_files_QA/", c("oncgor", "salsal", "saltru", "salalp"))
specieslist <- c("oncgor", "salsal", "saltru", "salalp")


list.files(path = here(speciespath[1]), pattern = "Quantification Summary.txt")


combined_dfs <- list()
platelistlist <- list()
for (i in seq_along(speciespath)) {
  platelistlist[[i]] <- list.files(path = here(speciespath[i]), pattern = "Quantification Summary.txt")
  tmppath <- speciespath[i]
  species <- specieslist[i]
  dfs <- list()
  for (j in seq_along(platelistlist[[i]])) {
    print(platelistlist[[i]][j])
    print(tmppath)
    dfs[[j]] <- read.table(here(tmppath, platelistlist[[i]][j]), header = T, sep = "\t") %>% 
       mutate(plate = paste0("plate", j)) %>% 
      mutate(species = specieslist[i]) %>% 
      mutate(filename = platelistlist[[i]][j])
    print(length(dfs))
    combined <- do.call("rbind",dfs)
    print(combined)
  
  }
    combined_dfs[[i]] <- combined
}

all_species <- do.call("rbind",combined_dfs) %>% 
  dplyr::select(Content, Sample, Cq, SQ, plate, species, filename) %>% 
  mutate(filter = as.character(Sample)) %>% 
  dplyr::mutate(SQ = as.numeric(SQ))

all_species_meta <- left_join(all_species, samples_meta, by = c("Sample" = "filter")) %>% 
  mutate(spec_edna_ngml = SQ/volume) %>% 
  dplyr::filter(Content == "Unkn") %>% 
  dplyr::filter(!is.na(dist_ocean)) %>% 
  dplyr::filter(!is.na(spec_edna_ngml)) %>% 
  mutate(species = as.factor(species))

dim(all_species_meta)

all_species_meta_median <- all_species_meta %>% 
  group_by(species, station, sampl_replicate, lat, lon) %>% 
  mutate(median_sq = median(spec_edna_ngml)) %>%  
  rowwise() %>% 
  mutate(mediandiff = abs(spec_edna_ngml-median_sq)) %>% 
  group_by(species, station, sampl_replicate, lat, lon) %>%
  slice_min(., order_by = mediandiff, n = 3)
  
all_species_meta_median_formodel <- all_species_meta_median %>% dplyr::select(-median_sq, -mediandiff, -edna_elut, -filename, -Cq, -Content, -plate, -SQ, -Sample)


writexl::write_xlsx(all_species_meta_median_formodel, here("data", "eDNAconc_salmonids_GrenseJRiver_finalw_PinkSalcounts.xlsx"))


```


```{r}
facetplot <- ggplot(all_species_meta, aes(x = dist_ocean, y = log10(SQ_vol), text = filename, group = station))+
  facet_grid(rows = vars(species))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(width = 0.5, aes(color = sampl_replicate))#+
  #geom_text(data = pinksal.summarised, aes(x = dist_hav, y = 0.2+max.edna, label = pinksal_groups$groups))+
  xlab("Distance from ocean (km)")+
  ylab("eDNA conc. (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  #scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  geom_smooth(aes(group = 1), se = TRUE, method = "gam",formula = y ~ poly(x, 4))+
  annotate("text", x = Inf, y = Inf, label = "Pink Salmon", hjust = 1.1, vjust = 1.3)
  
  ggplotly(facetplot_median)
```


# Pink salmon

```{r}




```

## Modify qPCR data file
Add dummy variable indicating qPCR technical replicate
Transform SQ to numeric
Arrange according to descending sample number for plotting
Add sampling station variable
Create new variable ng DNA / volume of filtered water
14.11.2022: Multiplied ng DNA by 10, because concentration of standards were wrongly adjusted to qubit value (NanoDrop was correct). # 03.04 fixed standard concentration in original .pcrd files 

```{r}

fishlim <- c(1e-8,5e-2)
fishbreaks <- c(1e-2, 1e-3, 1e-4, 1e-5, 1e-6, 1e-7, 1e-8)

ps_finn_forplot <- quant_pinksal_finn %>% 
  dplyr::select(Content, Sample, Cq, SQ, detect) %>% 
  dplyr::filter(Sample %in% as.character(c(567:584))) %>% 
  dplyr::arrange(desc(Sample)) %>% 
  dplyr::mutate(Sample = factor(Sample)) %>% 
  dplyr::mutate(SQ = as.numeric(SQ)) %>% 
  dplyr::mutate(tech_rep = factor(rep(c(1:6), 18))) %>% 
  left_join(., samples_meta, by = c("Sample" = "provenr")) %>% 
  mutate(SQ_vol = 10*SQ/volum) %>% 
  mutate(stasjon = factor(as.character(stasjon, ordered = T, levels = c("4","3","2","1","5","6"))))



ps_finn_forplot2 <- left_join(ps_finn_forplot, stasj_dist, by = "stasjon")


pslm <- lm(formula = log(SQ_vol) ~ dist_hav, data=ps_finn_forplot2)
summary(pslm)


psgam <- gam(formula = log(SQ_vol) ~ s(dist_hav, k =6), data=ps_finn_forplot2)
summary(psgam) 

psgampoly1 <- gam(formula = log(SQ_vol) ~ poly(dist_hav,4), data=ps_finn_forplot2)
summary(psgampoly1)

psgampoly2 <- gam(formula = log(SQ_vol) ~ poly(dist_hav,5), data=ps_finn_forplot2)
summary(psgampoly2)

anova(pslm, psgampoly)
anova(pslm, psgam)
summary(anova(psgampoly, psgam))

# Plot pink salmon eDNA conc as function of distance from ocean
ps_finn_plt2 <- ggplot(data = ps_finn_forplot2, aes(x = dist_hav, y = SQ_vol, color = sample_rep), show.legend = FALSE)+
  geom_jitter(width = 0.1, size = 1.5)+
  xlab("Distance from ocean (km)")+
  ylab("eDNA (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  theme(legend.position = "none")
ps_finn_plt2

ragg::agg_png("onchogorb_gje_correct.png", width = 6, height = 2.5, units = "in", res = 300, scaling = 1.5)
 ps_finn_plt2
 dev.off()

 ps_wlm <- ps_finn_plt2+
   geom_smooth(method = "lm", mapping=aes(y=exp(predict(pslm,ps_finn_forplot2))), color = "black")+
   annotate("text", x = Inf, y = Inf, label = "Pink Salmon", hjust = 1.1, vjust = 1.3)
 
 ps_wgam <- ps_finn_plt2+
   geom_smooth(method = "gam",formula = y ~ s(x, k = 6),  mapping=aes(y=exp(predict(psgam, ps_finn_forplot2))), color = "black")+
   annotate("text", x = Inf, y = Inf, label = "Pink Salmon", hjust = 1.1, vjust = 1.3)
 ps_wgam
 
 ragg::agg_png("onchogorb_gje_correct_wlm.png", width = 6, height = 2.5, units = "in", res = 300, scaling = 1.5)
 ps_wlm
 dev.off()
 
 # calculate median concentration
medeDNAconc_pinksal_rep <- ps_finn_forplot2 %>% 
  group_by(lat, lon, stasjon, fylke.x) %>% 
  summarise_if(is.numeric, ~median(., na.rm = T)) %>% 
  mutate(species = "pinksal") %>% ungroup()
medeDNAconc_pinksal[is.na(medeDNAconc_pinksal)] <- 0




# calculate median concentration, sample rep
medeDNAconc_pinksal_rep <- ps_finn_forplot2 %>% 
  group_by(lat, lon, stasjon, fylke.x, sample_rep) %>% 
  summarise_if(is.numeric, ~median(., na.rm = T)) %>% 
  mutate(species = "pinksal") %>% ungroup()

cor.test(medeDNAconc_pinksal_rep$dist_hav, medeDNAconc_pinksal_rep$SQ_vol, method = "kendall")

psgammed <- gam(formula = log(SQ_vol) ~ s(dist_hav, k = 6), method = "REML", data=medeDNAconc_pinksal_rep)
summary(psgammed) 
psgammed$aic

psgammedpoly4 <- gam(formula = log(SQ_vol) ~ poly(dist_hav,4), data=medeDNAconc_pinksal_rep)
summary(psgammedpoly4)
psgammedpoly4$aic

psgammedpoly3 <- gam(formula = log(SQ_vol) ~ poly(dist_hav,3), data=medeDNAconc_pinksal_rep)
summary(psgammedpoly3)
psgammedpoly3$aic

predict(psgammedpoly)

anova(psgammedpoly4, psgammed, test = "Chisq")

ps_median <- ggplot(data = medeDNAconc_pinksal_rep, aes(x = dist_hav, y = SQ_vol), show.legend = FALSE)+
  geom_point()+
  xlab("Distance from ocean (km)")+
  ylab("eDNA (ng/mL)")+
  scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  theme(legend.position = "none")
ps_median

ps_median +
  geom_smooth(method = "gam",formula = y ~ s(x, k = 6),  mapping=aes(y=exp(predict(psgammed, medeDNAconc_pinksal))), color = "black")

ps_median +
  geom_smooth(method = "gam",formula = y ~ poly(x, 3),  mapping=aes(y=exp(predict(psgammedpoly3, medeDNAconc_pinksal_rep))), color = "black")





pinksalmon_values <- ps_finn_forplot2 %>% 
  dplyr::select(Sample, detect, SQ_vol, volum, dist_hav, lat, lon, provetatt2, stasjon, sample_rep) %>%   rename(target_dna_conc_ngmL = SQ_vol) %>% 
  mutate(dato = as.Date.character(provetatt2, format = "%d.%m.%Y")) %>% 
  select(-provetatt2) %>% 
  mutate(species = "pinksal")

medednaconc <- rbind(medeDNAconc_pinksal, medeDNAconc_strutta) %>% mutate(species = factor(species))


medednaconc <- rbind(ps_finn_forplot2[c("dist_hav", "SQ_vol")] %>% mutate(species = "pinksal"), strutta_finn_forplot2[c("dist_hav", "SQ_vol")] %>% mutate(species = "strutt")) %>% mutate(species = factor(species))

gammed <- gam(formula = log(SQ_vol) ~ s(dist_hav, by = species, k = 6), data=medednaconc)
summary(gammed) 

plot(gammed)

# pinksal_aov <- aov(log(SQ_vol) ~ stasjon, data = medeDNAconc_pinksal_rep)
# summary(pinksal_aov)
# 
# psalhsd <- agricolae::HSD.test(pinksal_aov, "stasjon", group = T)
# psalhsd


# Boxplot, pink salmon
pinksal_aov <- aov(log10(SQ_vol) ~ dist_hav, data = ps_finn_forplot2)
summary(pinksal_aov)

psalhsd <- agricolae::HSD.test(pinksal_aov, "dist_hav", group = T)
psalhsd

pinksal_groups <- psalhsd$groups %>% 
  rownames_to_column(., var = "dist_hav_fact") %>% tibble() %>% 
  mutate(dist_hav = as.double(dist_hav_fact)) %>% 
  arrange(dist_hav)




pinksal.summarised <- ps_finn_forplot2 %>% group_by(dist_hav, stasjon) %>% summarize(max.edna = max(log10(SQ_vol), na.rm = T))

pinksal_bp <- ggplot(ps_finn_forplot2, aes(x = dist_hav, y = log10(SQ_vol), group = stasjon))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(width = 0.5, aes(color = sample_rep))+
  geom_text(data = pinksal.summarised, aes(x = dist_hav, y = 0.2+max.edna, label = pinksal_groups$groups))+
  xlab("Distance from ocean (km)")+
  ylab("eDNA conc. (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  #scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  geom_smooth(aes(group = 1), se = TRUE, method = "gam",formula = y ~ poly(x, 4))+
  annotate("text", x = Inf, y = Inf, label = "Pink Salmon", hjust = 1.1, vjust = 1.3)
 # theme(legend.position = "none")

pinksal_bp

```



## Number of replicates detected, pink salmon
```{r}
pinksal_nrepdet_forplot <- left_join(pinksal_nrepdet, stasj_dist, by = "stasjon") %>% mutate(fraction = stringr::str_c(num_detect, n, sep = "/")) %>% ungroup() %>% dplyr::select(sample_rep, stasjon, fraction)

pinksal_nrepdet_forplot_wide <- pinksal_nrepdet_forplot %>% pivot_wider(names_from = stasjon, values_from = fraction) %>% dplyr::select(`4`, `3`, `2`, `1`, `5`, `6`)

nrep_pinksal_fin <- ps_finn_forplot %>% dplyr::group_by(Sample, sample_rep, stasjon) %>% count()
ndetect_pinksal_fin <- ps_finn_forplot %>% dplyr::group_by(Sample, sample_rep, stasjon) %>% summarise(num_detect = sum(detect))

pinksal_nrepdet <- left_join(nrep_pinksal_fin, ndetect_pinksal_fin, by = "Sample") %>% dplyr::select(-sample_rep.y, -stasjon.y) %>% rename(stasjon = stasjon.x, sample_rep = sample_rep.x) %>% 
  mutate(stasjon = factor(as.character(stasjon, ordered = T, levels = c("4","3","2","1","5","6"))))

```




# Atlantic salmon
```{r}

fishlim <- c(1e-6,5e-3)
fishbreaks <- c(1e-2, 1e-3, 1e-4, 1e-5, 1e-6, 1e-7, 1e-8)

quant_ssalar_fin1 <- read_delim(here("data", "EEG_2021-11-19_Ssalar_FinmSvalb_2samp3repsCFX96_054.txt")) %>% 
  mutate(plate = rep("plate1", dim(.)[1])) %>% 
  dplyr::filter(Sample %in% as.character(c(567,568,570,571,573,574,576,577,579,580,582,583,586,587,589,590,592,593))) %>% 
  arrange(desc(Sample)) %>%
  dplyr::mutate(tech_rep = factor(rep(c(1:3), 18)))

quant_ssalar_fin2 <- read_delim(here("data", "EEG_2021-11-24_Ssalar_svalfinnm_plate2_CFX96_054.txt")) %>% 
  mutate(plate = rep("plate2", dim(.)[1])) %>% 
  dplyr::filter(Sample %in% as.character(c(569,572,575,578,581,584,588,591,594))) %>% 
  arrange(desc(Sample)) %>%
  dplyr::mutate(tech_rep = factor(rep(c(1:3), 9)))

quant_ssalar_finn <- rbind(quant_ssalar_fin1, quant_ssalar_fin2) %>% 
  mutate(detect = ifelse(SQ == "NaN", 0, 1))

ssalar_finn_forplot <- quant_ssalar_finn %>% 
  dplyr::select(Content, Sample, Cq, SQ, detect) %>% 
  dplyr::filter(Sample %in% as.character(c(567:584))) %>% 
  dplyr::arrange(desc(Sample)) %>% 
  dplyr::mutate(Sample = factor(Sample)) %>% 
  dplyr::mutate(SQ = as.numeric(SQ)) %>% 
  #dplyr::mutate(tech_rep = factor(rep(c(1:6), 18))) %>% 
  left_join(., samples_meta, by = c("Sample" = "provenr")) %>% 
  mutate(SQ_vol = 10*SQ/volum) %>% 
  mutate(stasjon = factor(as.character(stasjon, ordered = T, levels = c("4","3","2","1","5","6"))))

ssalar_finn_forplot2 <- left_join(ssalar_finn_forplot, stasj_dist, by = "stasjon")



# Plot salmo trutta eDNA conc as function of distance from ocean
sslm <- lm(formula = log(SQ_vol) ~ dist_hav, data=ssalar_finn_forplot2)
summary(sslm)

ssgam <- gam(formula = log(SQ_vol) ~ s(dist_hav, k =6), data=ssalar_finn_forplot2, method = "REML")
summary(ssgam) 
AIC(ssgam)

ssgampoly <- gam(formula = log(SQ_vol) ~ poly(dist_hav,5), data=ssalar_finn_forplot2)
summary(ssgampoly)

plot(ssalar_finn_forplot2$dist_hav, unname(predict.gam(ssgampoly)))

ssalartab <- ssalar_finn_forplot2 %>% mutate(predgam = c(unname(predict.gam(ssgam))))
ggplot(ssalartab, aes(x = dist_hav, y = predgam))+
  geom_point()

anova(sslm, ssgampoly)
anova(ssgampoly3, ssgampoly4, test = "Chisq")
ssalar_finn_forplot22 <- ssalar_finn_forplot2 %>% dplyr::filter(stasjon != "6")

ssalar_finn_plt2 <- ggplot(data = ssalar_finn_forplot2, aes(x = dist_hav, y = SQ_vol, color = sample_rep), show.legend = FALSE)+
  geom_jitter(width = 0.1, size = 1.5)+
  xlab("Distance from ocean (km)")+
  ylab("eDNA (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  theme(legend.position = "none")
ssalar_finn_plt2


ragg::agg_png("salsalar_gje_corrected.png", width = 6, height = 2.5, units = "in", res = 300, scaling = 1.5)
 ssalar_finn_plt2
 dev.off()

 ssal_wlm <- ssalar_finn_plt2+
   geom_smooth(method = "lm", mapping=aes(y=exp(predict(sslm,ssalar_finn_forplot2))), color = "black")+
   annotate("text", x = Inf, y = Inf, label = "Atlantic Salmon", hjust = 1.1, vjust = 1.3)
 
 ssal_wgam <- ssalar_finn_plt2+
   geom_smooth(method = "gam",formula = y ~ s(x, k = 6),  mapping=aes(y=exp(predict(ssgam, ssalar_finn_forplot2))), color = "black")+
   annotate("text", x = Inf, y = Inf, label = "Atlantic Salmon", hjust = 1.1, vjust = 1.3)
 
 
 ragg::agg_png("salsalar_gje_wlm_corrected.png", width = 6, height = 2.5, units = "in", res = 300, scaling = 1.5)
 ssal_wlm
 dev.off()

# calculate median concentration
medeDNAconc_ssalar <- ssalar_finn_forplot2 %>% 
  group_by(lat, lon, stasjon, fylke.x) %>% 
  summarise_if(is.numeric, ~median(., na.rm = T)) %>% 
  mutate(species = "ssalar") %>% 
  ungroup()

medeDNAconc_ssalar[is.na(medeDNAconc_ssalar)] <- 0

ssgammed <- gam(formula = log(SQ_vol) ~ s(dist_hav, k =6), data=medeDNAconc_ssalar)
summary(ssgammed)

ssgammedpoly2 <- gam(formula = log(SQ_vol) ~ poly(dist_hav,2), data=medeDNAconc_ssalar)
summary(ssgammedpoly2)

ssgammedpoly3 <- gam(formula = log(SQ_vol) ~ poly(dist_hav,3), data=medeDNAconc_ssalar)
summary(ssgammedpoly3)

anova(ssgammed,ssgammedpoly3,  test = "Chisq")

ss_median <- ggplot(data = medeDNAconc_ssalar, aes(x = dist_hav, y = SQ_vol), show.legend = FALSE)+
  geom_point()+
  xlab("Distance from ocean (km)")+
  ylab("eDNA (ng/mL)")+
  scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  theme(legend.position = "none")
ss_median

ss_median +
  geom_smooth(method = "gam",formula = y ~ s(x, k = 6),  mapping=aes(y=exp(predict(ssgammed, medeDNAconc_ssalar))), color = "black")

ss_median +
  geom_smooth(method = "gam",formula = y ~ poly(x, 4), color = "black")


# calculate median rep concentration
medeDNAconc_ssalar_rep <- ssalar_finn_forplot2 %>% 
  group_by(lat, lon, stasjon, fylke.x, sample_rep) %>% 
  summarise_if(is.numeric, ~median(., na.rm = T)) %>% 
  mutate(species = "ssalar") %>% 
  ungroup()

cor.test(medeDNAconc_ssalar_rep$dist_hav, medeDNAconc_ssalar_rep$SQ_vol, method = "kendall")

#medeDNAconc_ssalar[is.na(medeDNAconc_ssalar)] <- 0

ssgammed <- gam(formula = log(SQ_vol) ~ s(dist_hav, k =6), data=medeDNAconc_ssalar_rep, method = "REML")
summary(ssgammed)
ssgammed$aic


ssgammedpoly5 <- gam(formula = log(SQ_vol) ~ poly(dist_hav,5), data=medeDNAconc_ssalar_rep)
summary(ssgammedpoly5)
ssgammedpoly5$aic


ssgammedpoly3 <- gam(formula = log(SQ_vol) ~ poly(dist_hav,3), data=medeDNAconc_ssalar_rep)
summary(ssgammedpoly3)
ssgammedpoly3$aic

anova(ssgammed,ssgammedpoly5,  test = "Chisq")


ss_median_rep <- ggplot(data = medeDNAconc_ssalar_rep, aes(x = dist_hav, y = SQ_vol), show.legend = FALSE)+
  geom_jitter(width = 0.5)+
  xlab("Distance from ocean (km)")+
  ylab("eDNA (ng/mL)")+
  scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  theme(legend.position = "none")
ss_median_rep

ss_median_rep +
  geom_smooth(method = "gam",formula = y ~ s(x, k = 6),  mapping=aes(y=exp(predict(ssgammed, medeDNAconc_ssalar_rep))), color = "black")

ss_median_rep +
  geom_smooth(method = "gam",formula = y ~ poly(x, 5),mapping=aes(y=exp(predict(ssgammedpoly2, medeDNAconc_ssalar_rep))), color = "black")


medeDNAconc_ssalar_map <- leaflet(medeDNAconc_ssalar) %>% 
    addTiles() %>% 
     fitBounds(~min(lon, na.rm = TRUE), ~min(lat, na.rm = TRUE), ~max(lon, na.rm = TRUE), ~max(lat, na.rm = TRUE)+0.04) %>% 
  addCircleMarkers(color = "red", radius = ~log(SQ_vol*10e7)) #%>% 
  # addLabelOnlyMarkers(label = ~as.character(stasjon), labelOptions = labelOptions(noHide = T, direction = 'left', textOnly = T, textsize = "20px"))

mapshot(medeDNAconc_ssalar_map, file = "eDNAconc_ssalar_map.png")


# Values
atlanticsalmon_values <- ssalar_finn_forplot2 %>% 
  dplyr::select(Sample, detect, SQ_vol, volum, dist_hav, lat, lon, provetatt2, stasjon, sample_rep) %>%   rename(target_dna_conc_ngmL = SQ_vol) %>% 
  mutate(dato = as.Date.character(provetatt2, format = "%d.%m.%Y")) %>% 
  select(-provetatt2) %>% 
  mutate(species = "atlsal")




ggplot(ssalar_finn_forplot2, aes(x = dist_hav, y = log10(SQ_vol), group = stasjon))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(width = 0.5, aes(color = sample_rep))+
  geom_text(data = ssalar.summarised, aes(x = dist_hav, y = 0.2+max.edna, label = ssalarhsd$groups$groups))



# Boxplot Atlantic salmon
ssalar_aov <- aov(log10(SQ_vol) ~ dist_hav, data = ssalar_finn_forplot2)
summary(ssalar_aov)

ssalarhsd <- agricolae::HSD.test(ssalar_aov, "dist_hav", group = T)
ssalarhsd

ssalar_groups <- ssalarhsd$groups %>% 
  rownames_to_column(., var = "dist_hav_fact") %>% tibble() %>% 
  mutate(dist_hav = as.double(dist_hav_fact)) %>% 
  arrange(dist_hav)

ssalar.summarised <- ssalar_finn_forplot2 %>% group_by(dist_hav, stasjon) %>% summarize(max.edna = max(log10(SQ_vol), na.rm = T))

ssalar_bp <- ggplot(ssalar_finn_forplot2, aes(x = dist_hav, y = log10(SQ_vol), group = stasjon))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(width = 0.5, aes(color = sample_rep))+
  geom_text(data = ssalar.summarised, aes(x = dist_hav, y = 0.2+max.edna, label = ssalar_groups$groups))+
  xlab("Distance from ocean (km)")+
  ylab("eDNA conc. (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  #scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  #geom_smooth(aes(group = 1))+
  geom_smooth(aes(group = 1), se = TRUE, method = "gam",formula = y ~ s(x, k = 6))+
  annotate("text", x = Inf, y = Inf, label = "Atlantic Salmon", hjust = 1.1, vjust = 1.3)
 # theme(legend.position = "none")

ssalar_bp

 
```

# Trout
```{r}
quant_trout_fin1 <- read_delim(here("data", "EEG_2021-11-15_Trout_finn_svalb_plate1_CFX96_038st2.txt")) %>% 
  mutate(plate = rep("plate1", dim(.)[1])) %>% 
  dplyr::filter(Sample %in% as.character(c(567,568,570,571,573,574,576,577,579,580,582,583,586,587,589,590,592,593))) %>% 
  arrange(desc(Sample))

quant_trout_fin2 <- read_delim(here("data", "EEG_2021-11-24_trout_svalfinnm_plate2_CFX96_038std.txt")) %>% 
  mutate(plate = rep("plate2", dim(.)[1])) %>% 
  dplyr::filter(Sample %in% as.character(c(567,569,570,572,573,575,576, 578,579,581,582,584,586,588,589,591,592,594))) %>% 
arrange(desc(Sample)) #%>% 
  #dplyr::mutate(tech_rep = factor(rep(c(1:6), 9))) #Added tech rep manually


quant_strutta_finn <- rbind(quant_trout_fin1, quant_trout_fin2) %>% 
  mutate(detect = ifelse(SQ == "NaN", 0, 1))




strutta_finn_forplot <- quant_strutta_finn %>% 
  dplyr::select(Content, Sample, Cq, SQ, detect) %>% 
  dplyr::filter(Sample %in% as.character(c(567:584))) %>% 
  dplyr::arrange(desc(Sample)) %>% 
  dplyr::mutate(Sample = factor(Sample)) %>% 
  dplyr::mutate(SQ = as.numeric(SQ)) %>% 
  #dplyr::mutate(tech_rep = factor(rep(c(1:6), 18))) %>% 
  left_join(., samples_meta, by = c("Sample" = "provenr")) %>% 
  mutate(SQ_vol = 10*SQ/volum) %>% 
  mutate(stasjon = factor(as.character(stasjon, ordered = T, levels = c("4","3","2","1","5","6"))))

strutta_finn_forplot2 <- left_join(strutta_finn_forplot, stasj_dist, by = "stasjon")


stlm <- lm(formula = log(SQ_vol) ~ dist_hav, data=strutta_finn_forplot2)
summary(stlm)

stgam <- gam(formula = log(SQ_vol) ~ s(dist_hav, k =6), data=strutta_finn_forplot2)
summary(stgam) 

stgampoly <- gam(formula = log(SQ_vol) ~ poly(dist_hav,5), data=strutta_finn_forplot2)
summary(stgampoly)

anova(stlm, stgampoly)
summary(anova(psgampoly, psgam))

# Plot salmo trutta eDNA conc as function of distance from ocean
strutta_finn_plt2 <- ggplot(data = strutta_finn_forplot2, aes(x = dist_hav, y = SQ_vol, color = sample_rep), show.legend = FALSE)+
  geom_jitter(width = 0.1, size = 1.5)+
  xlab("Distance from ocean (km)")+
  ylab("eDNA (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  theme(legend.position = "none")
strutta_finn_plt2

ragg::agg_png("saltrut_gje_corrected.png", width = 6, height = 2.5, units = "in", res = 300, scaling = 1.5)
 strutta_finn_plt2
 dev.off()
 
 strut_wgam <- strutta_finn_plt2+
   geom_smooth(method = "gam",formula = y ~ s(x, k = 6),  mapping=aes(y=exp(predict(stgam, strutta_finn_forplot2))), color = "black")+
   annotate("text", x = Inf, y = Inf, label = "Trout", hjust = 1.1, vjust = 1.3)
 strut_wgam
 
 strut_wpoly <- strutta_finn_plt2+
   geom_smooth(method = "gam",formula = y ~ poly(x,5),  mapping=aes(y=exp(predict(stgampoly, strutta_finn_forplot2))), color = "black")+
   annotate("text", x = Inf, y = Inf, label = "Trout", hjust = 1.1, vjust = 1.3)
 strut_wgam
 
 strut_wlm <- strutta_finn_plt2+
   geom_smooth(method = "lm", mapping=aes(y=exp(predict(stlm, strutta_finn_forplot2))), color = "black")+
   annotate("text", x = Inf, y = Inf, label = "Trout", hjust = 1.1, vjust = 1.3)


 ragg::agg_png("saltrut_gje_wgam_corrected.png", width = 6, height = 2.5, units = "in", res = 300, scaling = 1.5)
 strut_wgam
 dev.off()

# calculate median concentration
medeDNAconc_strutta <- strutta_finn_forplot2 %>% 
  group_by(lat, lon, stasjon, fylke.x) %>% 
  summarise_if(is.numeric, ~median(., na.rm = T)) %>% 
  mutate(species = "strutta") %>% ungroup()

medeDNAconc_strutta[is.na(medeDNAconc_strutta)] <- 0

strutgammed <- gam(formula = log(SQ_vol) ~ s(dist_hav, k = 6), data=medeDNAconc_strutta)
summary(strutgammed)
plot(strutgammed)



medeDNAconc_strutta_map <- leaflet(medeDNAconc_strutta) %>% 
    addTiles() %>% 
     fitBounds(~min(lon, na.rm = TRUE), ~min(lat, na.rm = TRUE), ~max(lon, na.rm = TRUE), ~max(lat, na.rm = TRUE)+0.04) %>% 
  addCircleMarkers(color = "red", radius = ~log(SQ_vol*10e7)) #%>% 
  # addLabelOnlyMarkers(label = ~as.character(stasjon), labelOptions = labelOptions(noHide = T, direction = 'left', textOnly = T, textsize = "20px"))

mapshot(medeDNAconc_strutta_map, file = "eDNAconc_strutta_map2.png")

# calculate median concentration rep
medeDNAconc_strutta_rep <- strutta_finn_forplot2 %>% 
  group_by(lat, lon, stasjon, fylke.x, sample_rep) %>% 
  summarise_if(is.numeric, ~median(., na.rm = T)) %>% 
  mutate(species = "strutta") %>% ungroup()

#medeDNAconc_strutta[is.na(medeDNAconc_strutta)] <- 0

cor.test(medeDNAconc_strutta_rep$dist_hav, medeDNAconc_strutta_rep$SQ_vol, method = "kendall")

stgammed <- gam(formula = log(SQ_vol) ~ s(dist_hav, k = 6), method = "REML", data=medeDNAconc_strutta_rep)
summary(stgammed)
plot(stgammed)
stgammed$aic


 

stgampoly5 <- gam(formula = log(SQ_vol) ~ poly(dist_hav,5), data=medeDNAconc_strutta_rep)
summary(stgampoly5)
stgampoly5$aic

stgampoly4 <- gam(formula = log(SQ_vol) ~ poly(dist_hav,4), data=medeDNAconc_strutta_rep)
summary(stgampoly4)
stgampoly4$aic

stgampoly1 <- gam(formula = log(SQ_vol) ~ poly(dist_hav,1), data=medeDNAconc_strutta_rep)
summary(stgampoly1)
stgampoly1$aic

anova(stgammed,stgampoly,  test = "Chisq")

st_median_rep <- ggplot(data = medeDNAconc_strutta_rep, aes(x = dist_hav, y = SQ_vol), show.legend = FALSE)+
  geom_jitter(width = 0.5)+
  xlab("Distance from ocean (km)")+
  ylab("eDNA (ng/mL)")+
  scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  theme(legend.position = "none")
st_median_rep

st_median_rep +
  geom_smooth(method = "gam",formula = y ~ s(x, k = 6),  mapping=aes(y=exp(predict(stgammed, medeDNAconc_strutta_rep))), color = "black")

st_median_rep +
  geom_smooth(method = "gam",formula = y ~ poly(x, 1),mapping=aes(y=exp(predict(stgampoly, medeDNAconc_strutta_rep))), color = "black")



# Boxplot Trout
strutta_aov <- aov(log10(SQ_vol) ~ dist_hav, data = strutta_finn_forplot2)
summary(strutta_aov)

struttahsd <- agricolae::HSD.test(strutta_aov, "dist_hav", group = T)
struttahsd

strutta_groups <- struttahsd$groups %>% 
  rownames_to_column(., var = "dist_hav_fact") %>% tibble() %>% 
  mutate(dist_hav = as.double(dist_hav_fact)) %>% 
  arrange(dist_hav)

strutta.summarised <- strutta_finn_forplot2 %>% group_by(dist_hav, stasjon) %>% summarize(max.edna = max(log10(SQ_vol), na.rm = T))

strutta_bp <- ggplot(strutta_finn_forplot2, aes(x = dist_hav, y = log10(SQ_vol), group = stasjon))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(width = 0.5, aes(color = sample_rep))+
  geom_text(data = strutta.summarised, aes(x = dist_hav, y = 0.2+max.edna, label = strutta_groups$groups))+
  xlab("Distance from ocean (km)")+
  ylab("eDNA conc. (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  #scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  #geom_smooth(aes(group = 1))+
  geom_smooth(aes(group = 1), se = TRUE, method = "gam",formula = y ~ s(x, k = 6), level = 0.95)+
  annotate("text", x = Inf, y = Inf, label = "Trout", hjust = 1.1, vjust = 1.3)
 # theme(legend.position = "none")

strutta_bp

strutta_aov <- aov(log(SQ_vol) ~ stasjon, data = medeDNAconc_strutta_rep)
summary(strutta_aov)
struttahsd <- agricolae::HSD.test(strutta_aov, "stasjon", group = T)
struttahsd

strutta_aov <- aov(log10(SQ_vol) ~ dist_hav, data = strutta_finn_forplot2)
summary(strutta_aov)
struttahsd <- agricolae::HSD.test(strutta_aov, "dist_hav", group = T, unbalanced = T)
struttahsd


strutta.summarised <- strutta_finn_forplot2 %>% group_by(dist_hav, stasjon) %>% summarize(max.edna = max(log10(SQ_vol)))

ggplot(strutta_finn_forplot2, aes(x = dist_hav, y = log10(SQ_vol), group = stasjon))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(width = 0.5, aes(color = sample_rep))+
  geom_text(data = strutta.summarised, aes(x = dist_hav, y = 0.2+max.edna, label = struttahsd$groups$groups))




# Values
salmotrutta_values <- strutta_finn_forplot2 %>% 
  dplyr::select(Sample, detect, SQ_vol, volum, dist_hav, lat, lon, provetatt2, stasjon, sample_rep) %>%   rename(target_dna_conc_ngmL = SQ_vol) %>% 
  mutate(dato = as.Date.character(provetatt2, format = "%d.%m.%Y")) %>% 
  select(-provetatt2) %>% 
  mutate(species = "trout")


```

# Arctic char
```{r}
quant_achar_finsval1 <- read_delim(here("data", "EEG_2021-11-15_Acharr_FinSval_plate1_CFX96_016.txt")) %>% 
  mutate(plate = rep("plate1", dim(.)[1])) %>% 
  dplyr::filter(Sample %in% as.character(c(567,568,570,571,573,574,576,577,579,580,582,583,586,587,589,590,592,593))) %>% 
  arrange(desc(Sample)) %>%
  dplyr::mutate(tech_rep = factor(rep(c(1:3), 18)))

quant_achar_finsval2 <- read_delim(here("data", "EEG_2021-11-17_Acharr_finm_svalb_samprep3CFX96_016.txt")) %>% 
  mutate(plate = rep("plate2", dim(.)[1])) %>% 
  dplyr::filter(Sample %in% as.character(c(569,572,575,578,581,584,588,591,594))) %>% 
arrange(desc(Sample)) %>% 
  dplyr::mutate(tech_rep = factor(rep(c(1:6), 9)))

quant_achar_finsval3 <- read_delim(here("data", "EEG_2021-11-26_Acharr_finm_svalb_samprep12_techrep46CFX96_016.txt")) %>% 
  mutate(plate = rep("plate3", dim(.)[1])) %>% 
  dplyr::filter(Sample %in% as.character(c(567,568,570,571,573,574,576,577,579, 580, 582, 583, 592,593))) %>% 
  arrange(desc(Sample)) %>% 
  dplyr::mutate(tech_rep = factor(c(c(4,5,4,5), rep((4:6), 12))))

quant_salpin_finn <- rbind(quant_achar_finsval1, quant_achar_finsval2, quant_achar_finsval3) %>% mutate(detect = ifelse(SQ == "NaN", 0, 1))

salpin_finn_forplot <- quant_salpin_finn %>% 
  dplyr::select(Content, Sample, Cq, SQ, detect) %>% 
  dplyr::filter(Sample %in% as.character(c(567:584))) %>% 
  dplyr::arrange(desc(Sample)) %>% 
  dplyr::mutate(Sample = factor(Sample)) %>% 
  dplyr::mutate(SQ = as.numeric(SQ)) %>% 
  #dplyr::mutate(tech_rep = factor(rep(c(1:6), 18))) %>% 
  left_join(., samples_meta, by = c("Sample" = "provenr")) %>% 
  mutate(SQ_vol = 10*SQ/volum) %>% 
  mutate(stasjon = factor(as.character(stasjon, ordered = T, levels = c("4","3","2","1","5","6"))))

salpin_finn_forplot2 <- left_join(salpin_finn_forplot, stasj_dist, by = "stasjon")


salm <- lm(formula = log(SQ_vol) ~ dist_hav, data=salpin_finn_forplot2)
summary(salm)

salpgam <- gam(formula = log(SQ_vol) ~ s(dist_hav, k = 6), data=salpin_finn_forplot2)
summary(salpgam)

salpgampoly <- gam(formula = log(SQ_vol) ~ poly(dist_hav,5), data=salpin_finn_forplot2)
summary(salpgampoly)


# Plot salmo trutta eDNA conc as function of distance from ocean
salpin_finn_plt2 <- ggplot(data = salpin_finn_forplot2, aes(x = dist_hav, y = SQ_vol, color = sample_rep), show.legend = FALSE)+
  geom_jitter(width = 0.1, size = 1.5)+
  xlab("Distance from ocean (km)")+
  ylab("eDNA (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  theme(legend.position = "none")
salpin_finn_plt2

ragg::agg_png("salpin_gje_corrected.png", width = 6, height = 2.5, units = "in", res = 300, scaling = 1.5)
 salpin_finn_plt2
 dev.off()

 salp_wlm <- salpin_finn_plt2+
   geom_smooth(method = "lm", mapping=aes(y=exp(predict(salm, salpin_finn_forplot2))), color = "black", linetype = "dashed")+
   annotate("text", x = Inf, y = Inf, label = "Arctic charr", hjust = 1.1, vjust = 1.3)
salp_wlm

 salp_wgam <- salpin_finn_plt2+
   geom_smooth(method = "gam",formula = y ~ s(x, k = 6),  mapping=aes(y=exp(predict(salpgam, salpin_finn_forplot2))), color = "black")+
   annotate("text", x = Inf, y = Inf, label = "Arctic Charr", hjust = 1.1, vjust = 1.3)
 
 salp_wgam <- salpin_finn_plt2+
   geom_smooth(method = "gam",formula = y ~ s(x, k = 6),  mapping=aes(y=exp(predict(salpgam)), x = salpin_finn_forplot2$dist_hav), color = "black")+
   annotate("text", x = Inf, y = Inf, label = "Arctic Charr", hjust = 1.1, vjust = 1.3)
 
salp_wgam
 
 
 ragg::agg_png("salpin_gje_wlm_corrected.png", width = 6, height = 2.5, units = "in", res = 300, scaling = 1.5)
 salp_wlm
 dev.off()

# calculate median concentration
medeDNAconc_salpin <- salpin_finn_forplot2 %>% 
  group_by(lat, lon, stasjon, fylke.x) %>% 
  summarise_if(is.numeric, ~median(., na.rm = T)) %>% 
  mutate(species = "salpin") %>% ungroup()

medeDNAconc_salpin[is.na(medeDNAconc_salpin)] <- 0

salpgammed <- gam(formula = log(SQ_vol) ~ s(dist_hav, k = 6), data=medeDNAconc_salpin)
summary(salpgammed)
plot(salpgammed)

medeDNAconc_salpin_map <- leaflet(medeDNAconc_salpin) %>% 
    addTiles() %>% 
     fitBounds(~min(lon, na.rm = TRUE), ~min(lat, na.rm = TRUE), ~max(lon, na.rm = TRUE), ~max(lat, na.rm = TRUE)+0.04) %>% 
  addCircleMarkers(color = "red", radius = ~log(SQ_vol*10e7)) #%>% 
  # addLabelOnlyMarkers(label = ~as.character(stasjon), labelOptions = labelOptions(noHide = T, direction = 'left', textOnly = T, textsize = "20px"))

mapshot(medeDNAconc_salpin_map, file = "eDNAconc_salpin_map2.png")

# Median sample rep concentrations

medeDNAconc_salpin_rep <- salpin_finn_forplot2 %>% 
  group_by(lat, lon, stasjon, fylke.x, sample_rep) %>% 
  summarise_if(is.numeric, ~median(., na.rm = T)) %>% 
  mutate(species = "salpin") %>% ungroup() #%>% dplyr::filter(stasjon != 5)

#medeDNAconc_salpin[is.na(medeDNAconc_salpin)] <- 0
cor.test(medeDNAconc_salpin_rep$dist_hav, medeDNAconc_salpin_rep$SQ_vol, method = "kendall")

salpgammed <- gam(formula = log(SQ_vol) ~ s(dist_hav, k = 5), data=medeDNAconc_salpin_rep)
summary(salpgammed)
plot(salpgammed)
salpgammed$aic

salpgammedpoly5 <- gam(formula = log(SQ_vol) ~ poly(dist_hav,4), data=medeDNAconc_salpin_rep)
summary(salpgammedpoly5)
salpgammedpoly5$aic

salp_median <- ggplot(data = medeDNAconc_salpin_rep, aes(x = dist_hav, y = SQ_vol), show.legend = FALSE)+
  geom_jitter(width = 0.5)+
  xlab("Distance from ocean (km)")+
  ylab("eDNA (ng/mL)")+
  scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  theme(legend.position = "none")
salp_median

salp_median +
  geom_smooth(method = "gam",formula = y ~ s(x, k = 6),  mapping=aes(y=exp(predict(salpgammed, medeDNAconc_salpin_rep))), color = "black")

salp_median +
  geom_smooth(method = "gam",formula = y ~ poly(x, 4), color = "black", mapping=aes(y=exp(predict(salpgammedpoly5, medeDNAconc_salpin_rep))))


# Boxplot Char
salpin_aov <- aov(log10(SQ_vol) ~ dist_hav, data = salpin_finn_forplot2)
summary(salpin_aov)

salpinhsd <- agricolae::HSD.test(salpin_aov, "dist_hav", group = T, unbalanced = T)
salpinhsd

salpin_groups <- salpinhsd$groups %>% 
  rownames_to_column(., var = "dist_hav_fact") %>% tibble() %>% 
  mutate(dist_hav = as.double(dist_hav_fact)) %>% 
  arrange(dist_hav)

salpin.summarised <- salpin_finn_forplot2 %>% group_by(dist_hav, stasjon) %>% summarize(max.edna = max(log10(SQ_vol), na.rm = T))

salpin_bp_nosmooth <- ggplot(salpin_finn_forplot2, aes(x = dist_hav, y = log10(SQ_vol), group = stasjon))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(width = 0.5, aes(color = sample_rep))+
  geom_text(data = salpin.summarised, aes(x = dist_hav, y = 0.2+max.edna, label = salpin_groups$groups))+
  xlab("Distance from ocean (km)")+
  ylab("eDNA conc. (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  #scale_y_continuous(trans = "log10", limits = fishlim, breaks = fishbreaks)+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
  #geom_smooth(aes(group = 1), se = TRUE, method = "gam",formula = y ~ s(x, k = 6))
 # theme(legend.position = "none")
  annotate("text", x = Inf, y = Inf, label = "Arctic Char", hjust = 1.1, vjust = 1.3)
salpin_bp_nosmooth






# Values
arcticcharr_values <- salpin_finn_forplot2 %>% 
  dplyr::select(Sample, detect, SQ_vol, volum, dist_hav, lat, lon, provetatt2, stasjon, sample_rep) %>%   rename(target_dna_conc_ngmL = SQ_vol) %>% 
  mutate(dato = as.Date.character(provetatt2, format = "%d.%m.%Y")) %>% 
  select(-provetatt2) %>% 
  mutate(species = "arctchar")



```



# Arrange plots
```{r}
plotlist <- list(ps_finn_plt2+theme(axis.title.x = element_blank(), legend.position = "none"), 
                 ssalar_finn_plt2+theme(axis.title.x = element_blank(), legend.position = "none"), 
                 strutta_finn_plt2+theme(axis.title.x = element_blank(), legend.position = "none"), 
                 salpin_finn_plt2+theme(legend.position = "none"))

andro_arr <- ggarrange(plotlist = plotlist, nrow = length(plotlist), labels = LETTERS[1:4], legend = "right", align = "hv", common.legend = T)
andro_arr
ragg::agg_png("anadromous_arr2.png", width = 10, height = 12, units = "in", res = 300, scaling = 1.5)
 andro_arr
 dev.off()
 
# With regression line
 ps_
 
plotlist_wlm <- list(ps_wlm +theme(axis.title.x = element_blank(), legend.position = "none"),
                 ssal_wlm+theme(axis.title.x = element_blank(), legend.position = "none"), 
                 strut_wlm +theme(axis.title.x = element_blank(), legend.position = "none"),
                 salp_wlm+theme(legend.position = "none"))

andro_wlm_arr <- ggarrange(plotlist = plotlist_wlm, nrow = length(plotlist), labels = LETTERS[1:4], legend = "right", align = "hv", common.legend = T)
andro_wlm_arr

ragg::agg_png("anadromous_wlm_arr.png", width = 10, height = 12, units = "in", res = 300, scaling = 1.2)
 andro_wlm_arr
 dev.off()

 
 plotlist_bp <- list(pinksal_bp +theme(axis.title.x = element_blank()),
                 ssalar_bp+theme(axis.title.x = element_blank(), legend.position = "none"), 
                 strutta_bp +theme(axis.title.x = element_blank(), legend.position = "none"),
                 salpin_bp_nosmooth+theme(legend.position = "none"))
 
 andro_arr_bp <- ggarrange(plotlist = plotlist_bp, nrow = length(plotlist_bp), labels = LETTERS[1:4], legend = "right", align = "hv", common.legend = T)
andro_arr_bp
 
ragg::agg_png("anadromous_barplot_arr.png", width = 10, height = 12, units = "in", res = 300, scaling = 1.2)
 andro_arr_bp
 dev.off()
```

## Barchar median concentration
```{r}
medeDNAconc0 <- bind_rows(medeDNAconc_pinksal, medeDNAconc_salpin, medeDNAconc_ssalar, medeDNAconc_strutta) %>% 
  mutate(species = factor(species))

medeDNAconc <- medeDNAconc0 %>% 
  mutate(dist_hav_fact = factor(as.character(dist_hav), levels = rev(as.character(unique(medeDNAconc0$dist_hav))), ordered = T)) %>% 
  mutate(species = factor(species, levels = c("pinksal", "ssalar", "strutta", "salpin"), ordered = T))

dnabreaks = c(1e1, 1e2, 1e3, 1e4, 1e5, 1e6, 1e7)
dnalables = as.character(scientific(dnabreaks/1e8))

medeDNAconc %>% group_by(stasjon, species) %>% summarise_if(is.numeric, range) %>% ungroup() %>%  group_by(species) %>% slice_max(order_by = SQ_vol) %>% select(species, SQ_vol)

medeDNAconc %>% group_by(stasjon, species) %>% summarise_if(is.numeric, range) %>% ungroup() %>%  group_by(species) %>% slice_min(order_by = SQ_vol) %>% select(species, SQ_vol)

medconc <- ggplot(data = medeDNAconc, aes(x = dist_hav, y = SQ_vol*1e8, fill = species))+
  geom_bar(stat = "identity", position = "dodge")+
  ylab("eDNA (ng/mL)")+
  xlab("Distance from ocean (km)")+
  labs(fill = "Species")+
  scale_fill_discrete(labels = c("Pink salmon", "Atlantic salmon", "Trout", "Charr"))+
  scale_y_continuous(trans = "log10", breaks = c(1e1, 1e2, 1e3, 1e4, 1e5, 1e6, 1e7), labels = dnalables)+
  scale_x_continuous(breaks = c(10, 13.8, 19.8, 24.1, 28.1, 32))
medconc

ragg::agg_png("median_conc_allspec_correct.png", width = 10, height = 5, units = "in", res = 300, scaling = 1.5)
 medconc
 dev.off()

  

```
## Make file with values for all species for modeling
```{r}
allfishvalues <- rbind.data.frame(pinksalmon_values, atlanticsalmon_values, salmotrutta_values, arcticcharr_values) %>% 
  mutate(species = factor(species, ordered = TRUE, levels = c("pinksal", "atlsal", "trout", "arctchar")))

writexl::write_xlsx(allfishvalues, "eDNAconc_salmonids_GrenseJRiver.xlsx")
```

```{r}
allfish_bp <- ggplot(allfishvalues, aes(x = dist_hav, y = log10(target_dna_conc_ngmL)))+
  geom_boxplot(aes(fill = species, group = interaction(species, stasjon)), lwd =0.2, outlier.size = 1)+
  ylab("eDNA conc. (ng/mL)")+
  xlab("Station")+
  labs(fill = "Species")+
  scale_fill_discrete(labels = c("Pink salmon", "Atlantic salmon", "Trout", "Charr"))+
  #scale_y_continuous(trans = "log10", breaks = c(1e1, 1e2, 1e3, 1e4, 1e5, 1e6, 1e7), labels = dnalables)+
  scale_x_continuous(breaks = c(10, 13.8, 19.8, 24.1, 28.1, 32), labels = paste0("St. ", c(1:6)))+
  theme_bw()

labels_allspec <- allfishvalues %>% group_by(stasjon, dist_hav) %>%
  nest() %>%
  ungroup() %>% 
  mutate(aovv = map(.x = data, .f = ~aov(log10(.x$target_dna_conc_ngmL) ~ .x$species))) %>%
  mutate(groupp = map(aovv, ~agricolae::HSD.test(.x, ".x$species", group = T, unbalanced = TRUE))) %>% 
  mutate(maxval = map(.x = data, .f = ~max(log10(.x$target_dna_conc_ngmL), na.rm = T))) %>% 
  mutate(species = map(.x = data, .f = ~unique(.x$species))) %>% 
  rowwise() %>% 
  mutate(labels = list(across(groupp, ~.x$groups$groups))) %>% 
  ungroup() %>% 
  select(stasjon, dist_hav, maxval, labels, species) %>% 
  unnest(., c(labels, maxval, species)) %>% 
  arrange(desc(dist_hav))

xpos <- ggplot_build(allfish_bp)$data[[1]] %>% select(xmin, xmax) %>% rowwise() %>%  mutate(xlet = mean(xmin, xmax))

labels_allspec_2 <- labels_allspec %>% mutate(xlet = rev(xpos$xmax)) %>% 
  group_by(stasjon) %>% mutate(xletok = rev(xlet)) %>% ungroup

allfish_bp_sign <- allfish_bp +
  geom_text(data = labels_allspec_2, aes(x = xletok, y = maxval+0.2, label = groupp, group = interaction(species, stasjon)))

ragg::agg_png("allfish_boxplot.png", width = 10, height = 5, units = "in", res = 300, scaling = 1.5)
 allfish_bp_sign
 dev.off()
  

hoo <- agricolae::HSD.test(hm$aovv[[6]], ".x$species", group = T, unbalanced = F)

```

# Range concentrations
```{r}
allfishvalues
range <- allfishvalues %>% group_by(species, stasjon, dist_hav) %>% 
  summarise_if(is.numeric, ~median(., na.rm =T)) %>% 
 # ungroup() %>% 
  group_by(species) %>% filter(target_dna_conc_ngmL %in% range(target_dna_conc_ngmL, na.rm = T)) %>%
  group_by(species) %>% 
  arrange(species,target_dna_conc_ngmL) %>% 
  ungroup() %>% 
  mutate(minmax = rep(c("min", "max"), 4)) %>% 
  mutate(eDNAconc = scientific(target_dna_conc_ngmL, 2)) 

range_statsj <- range %>% 
  pivot_wider(., id_cols = c(species, stasjon), names_from = minmax, values_from = eDNAconc)

range_statsj


writexl::write_xlsx(range_statsj, here("range_ednaconc_stations.xlsx"))

range_spec <- range %>% 
  pivot_wider(., id_cols = c(species), names_from = minmax, values_from = target_dna_conc_ngmL) %>% 
  mutate(magnitudechange = log10(max/min))

range_spec

between_stat <- allfishvalues %>% group_by(species, stasjon, dist_hav) %>% 
  summarise_if(is.numeric, ~median(., na.rm =T))

changedata <- between_stat %>% pivot_wider(., id_cols = species, names_from = stasjon, values_from = target_dna_conc_ngmL, names_prefix = "stat") %>%
  mutate(st1_2 = log10((stat3)/stat4)) %>% 
  mutate(st2_3 = log10(stat2/stat3)) %>% 
  mutate(st3_4 = log10(stat1/stat2)) %>% 
  mutate(st4_5 = log10(stat5/stat1)) %>% 
  mutate(st5_6 = log10(stat6/stat5)) %>% 
  dplyr::select(-starts_with("stat")) %>% 
  pivot_longer(., cols = -species, names_to = "statcomp", values_to = "change")

changedata2 <- between_stat %>% pivot_wider(., id_cols = species, names_from = stasjon, values_from = target_dna_conc_ngmL, names_prefix = "stat") %>%
  mutate(st1_2 = -((stat4-stat3)/stat4)) %>% 
  mutate(st2_3 = -((stat3-stat2)/stat3)) %>% 
  mutate(st3_4 = -((stat2-stat1)/stat2)) %>% 
  mutate(st4_5 = -((stat1-stat5)/stat1)) %>% 
  mutate(st5_6 = -((stat5-stat6)/stat5)) %>% 
  dplyr::select(-starts_with("stat")) %>% 
  pivot_longer(., cols = -species, names_to = "statcomp", values_to = "change") %>% 
  mutate(Sign = sign(change)) %>% 
  mutate(heiiih = case_when(change >= 0 ~ change+1,
                            change < 0 ~ change-1))
  
  fishcols <- ggplot_build(allfish_bp)$data[[1]] %>% select(fill) %>% unique()
  
  stat_compareplot <- ggplot(changedata, aes(x = statcomp, y = 2+change, fill = species))+
  geom_bar(stat = "identity", position = "dodge")+
  scale_y_continuous(breaks = c(log10(0.05), log10(0.1), log10(0.5), 0, log10(5), 1, log10(20))+2, labels = c(0.05, 0.1, 0.5, 1, 5, 10, 20))+
  scale_x_discrete(labels = c("1 vs 2", "2 vs 3", "3 vs 4", "4 vs 5", "5 vs 6"))+
  labs(y = "Ratio of eDNA concentration", x = "Compared stations")+
  geom_hline(yintercept = 2)+
  scale_fill_manual(values = fishcols$fill, labels = c("Pink salmon", "Atlantic salmon", "Trout", "Charr"))+
  theme_classic()+
  labs(fill = "Species")

  #log10((1-change))*Sign

stat_compareplot2 <- ggplot(changedata2, aes(x = statcomp, y = log10(abs(heiiih))*Sign, fill = species))+
  geom_bar(stat = "identity", position = "dodge")+
  scale_y_continuous(breaks = c(-log10(1.9), -log10(1.5), log10(1), log10(2), log10(6), log10(11), log10(21)), labels = c(-0.9, -0.5, 0,2, 5, 10, 20))+
  scale_x_discrete(labels = c("1 vs 2", "2 vs 3", "3 vs 4", "4 vs 5", "5 vs 6"))+
  labs(y = "Relative change in eDNA concentration", x = "Compared stations")+
  scale_fill_manual(values = fishcols$fill, labels = c("Pink salmon", "Atlantic salmon", "Trout", "Charr"))+
  theme_classic()+
  labs(fill = "Species")
  
  stat_compareplot2

ragg::agg_png("compare_stations2.png", width = 10, height = 5, units = "in", res = 300, scaling = 1.5)
 stat_compareplot2
 dev.off()

```


