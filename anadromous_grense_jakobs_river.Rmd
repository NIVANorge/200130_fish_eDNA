---
title: "Anadromous salmonids in GJE"
author: "EEG"
date: "2022-10-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r, echo=FALSE}
library(here)
library(readr)
library(magrittr)
library(dplyr)
library(ggplot2)
library(cowplot)
library(ggpubr)
library(gridExtra)
library(tidyr)
library(leaflet)
library(mapview)
library(mgcv)
library(scales)
library(agricolae)
library(tibble)
library(plotly)
library(purrr)
library(grid)
library(patchwork)
<<<<<<< HEAD
library(plotly)
library(formattable)
=======
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
Sys.setlocale(locale='no_NB.utf8')
Sys.getlocale()
#remotes::install_github("r-spatial/mapview")

```


# Read meta data files
```{r}

samples_meta <- readxl::read_xlsx(here("data", "eDNAsamples_GJE_2021_Rform.xlsx")) %>% 
  mutate(sampl_replicate = as.factor(sampl_replicate))

```

# Read quantification data from QA pcrd-files
```{r}
speciespath <- paste0("pcrd_files/", c("oncgor", "salsal", "saltru", "salalp"))
<<<<<<< HEAD
specieslist <- c("oncgor", "salsal", "saltru", "salalp") #oncgor = Pink salmon, salsal = Atlantic salmon, saltru = trout, salalp = Arctic char
=======
specieslist <- c("oncgor", "salsal", "saltru", "salalp")
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b

list.files(path = here(speciespath[1]), pattern = "Quantification Summary.txt")

combined_dfs <- list()
platelistlist <- list()
for (i in seq_along(speciespath)) {
  platelistlist[[i]] <- list.files(path = here(speciespath[i]), pattern = "Quantification Summary.txt")
  tmppath <- speciespath[i]
  species <- specieslist[i]
  dfs <- list()
  for (j in seq_along(platelistlist[[i]])) {
    print(platelistlist[[i]][j])
    print(tmppath)
    dfs[[j]] <- read.table(here(tmppath, platelistlist[[i]][j]), header = T, sep = "\t") %>% 
       mutate(plate = paste0("plate", j)) %>% 
      mutate(species = specieslist[i]) %>% 
      mutate(filename = platelistlist[[i]][j]) %>% 
      janitor::remove_empty("cols")
    print(length(dfs))
    combined <- do.call("rbind",dfs)
  
  }
    combined_dfs[[i]] <- combined
}

all_species <- do.call("rbind",combined_dfs) %>% 
  dplyr::select(Content, Sample, Cq, SQ, plate, species, filename) %>% 
  mutate(filter = as.character(Sample)) %>% 
  dplyr::mutate(SQ = as.numeric(SQ))

# join with meta data
all_species_meta <- left_join(all_species, samples_meta, by = c("Sample" = "filter")) %>% 
  mutate(spec_edna_ngml = SQ/volume) %>% 
  dplyr::filter(Content == "Unkn") %>% 
  dplyr::filter(!is.na(dist_ocean)) %>% 
  dplyr::filter(!is.na(spec_edna_ngml)) %>% 
  mutate(species = as.factor(species))

dim(all_species_meta)

<<<<<<< HEAD
# for each sampling replicate (filter), select the 3 technical qPCR replicates which are closest to the median 
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
all_species_meta_median <- all_species_meta %>% 
  group_by(species, station, sampl_replicate, lat, lon) %>% 
  mutate(median_sq = median(spec_edna_ngml)) %>%  
  rowwise() %>% 
  mutate(mediandiff = abs(spec_edna_ngml-median_sq)) %>% 
  group_by(species, station, sampl_replicate, lat, lon) %>%
  slice_min(., order_by = mediandiff, n = 3)
  
all_species_meta_median_formodel <- all_species_meta_median %>% 
  dplyr::select(-median_sq, -mediandiff, -edna_elut, -Cq, -Content, -plate, -SQ, -Sample) %>% 
  mutate(species = factor(species, ordered = TRUE, levels = c("oncgor", "salsal", "saltru", "salalp")))


writexl::write_xlsx(all_species_meta_median_formodel, here("data", "eDNAconc_salmonids_GrenseJRiver_finalw_oncgorcounts.xlsx"))


```
<<<<<<< HEAD
# Read file with modeled eDNA concentrations
```{r}
model_edna <- readxl::read_xlsx(here("data", "modeled_edna_bestmod.xlsx"))

edna_unimod_og <- model_edna %>% dplyr::filter(species == "oncgor")
edna_expo_ss <- model_edna %>% dplyr::filter(species == "salsal")
edna_expo_st <- model_edna %>% dplyr::filter(species == "saltru")
edna_unimod_sa <- model_edna %>% dplyr::filter(species == "salalp")
```


# Interactive boxplot with all species in one for data exploration
```{r}
facetplot <- ggplot(all_species_meta_median_formodel, aes(x = dist_ocean, y = log10(spec_edna_ngml), text = filename, group = station))+
  facet_grid(rows = vars(species))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(width = 0.5, aes(color = sampl_replicate))+
=======
# Make boxplot function
```{r}
bp_fish_fun <- function(dat, var, )
```


```{r}
facetplot <- ggplot(all_species_meta_median_formodel, aes(x = dist_ocean, y = log10(spec_edna_ngml), text = filename, group = station))+
  facet_grid(rows = vars(species))+
  geom_boxplot(outlier.alpha = 0)+
  geom_jitter(width = 0.5, aes(color = sampl_replicate))#+
  #geom_text(data = oncgor.summarised, aes(x = dist_ocean, y = 0.2+max.edna, label = oncgor_groups$groups))+
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
  xlab("Distance from ocean (km)")+
  ylab("Log10 eDNA conc. (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
<<<<<<< HEAD
        plot.title = element_text(hjust = 0.5, size = 12))
=======
        plot.title = element_text(hjust = 0.5, size = 12))+
  #geom_smooth(aes(group = 1), se = TRUE, method = "gam",formula = y ~ poly(x, 4))+
  annotate("text", x = Inf, y = Inf, label = "Pink Salmon", hjust = 1.1, vjust = 1.3)
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
  
  ggplotly(facetplot)
```

<<<<<<< HEAD
# Separate plots for each species, with test of differences between stations
### Pink salmon
=======

# Pink salmon
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
```{r}
oncgor_med <- all_species_meta_median_formodel %>% dplyr::filter(species == "oncgor")

# Tukey multiple comparison test, pink salmon
oncgor_aov <- aov(log10(spec_edna_ngml) ~ dist_ocean, data = oncgor_med)
summary(oncgor_aov)

oncgor_hsd <- agricolae::HSD.test(oncgor_aov, "dist_ocean", group = T)
oncgor_hsd

oncgor_groups <- oncgor_hsd$groups %>% 
  rownames_to_column(., var = "dist_ocean_fact") %>% tibble() %>% 
  mutate(dist_ocean = as.double(dist_ocean_fact)) %>% 
  arrange(dist_ocean)


oncgor.summarised <- oncgor_med %>% group_by(dist_ocean, station) %>% summarize(max.edna = max(spec_edna_ngml, na.rm = T))
stationlab <- data.frame(dist_ocean = unique(samples_meta$dist_ocean), stat_name = paste0("St.", seq(1:6)), station = c(1:6))

oncgor_bp <- ggplot(oncgor_med, aes(x = dist_ocean, y = spec_edna_ngml, group = station))+
  geom_boxplot(outlier.alpha = 0)+
  geom_text(data = oncgor.summarised, aes(x = dist_ocean, y = max.edna+max.edna, label = oncgor_groups$groups))+
  geom_line(data = edna_unimod_og, aes(x = rev(km), y = mean/1000), colour = "blue", inherit.aes = F)+
  geom_ribbon(data = edna_unimod_og, aes(x = rev(km), ymin = min/1000, ymax = max/1000), alpha = 0.2, inherit.aes = F)+
  geom_jitter(width = 0.5, aes(color = sampl_replicate))+
  xlab("Distance from ocean (km)")+
  ylab("eDNA conc. (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  scale_y_continuous(trans = "log10")+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12),
        plot.margin = unit(c(0,0,0,0), "cm"))+
  annotate("text", x = Inf, y = Inf, label = "Pink Salmon", hjust = 1.1, vjust = 1.3)+
  scale_x_continuous(breaks = unique(oncgor_med$dist_ocean), sec.axis = dup_axis(name = "Station", labels = paste0("St.", seq(1:6))))

oncgor_bp



```

<<<<<<< HEAD
### Atlantic salmon
```{r}
salsal_med <- all_species_meta_median_formodel %>% dplyr::filter(species == "salsal")

# Tukey multiple comparison test, Atlantic salmon
=======
# Atlantic salmon
```{r}
salsal_med <- all_species_meta_median_formodel %>% dplyr::filter(species == "salsal")

# Tukey multiple comparison test, pink salmon
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
salsal_aov <- aov(log10(spec_edna_ngml) ~ dist_ocean, data = salsal_med)
summary(salsal_aov)

salsal_hsd <- agricolae::HSD.test(salsal_aov, "dist_ocean", group = T)
salsal_hsd

salsal_groups <- salsal_hsd$groups %>% 
  rownames_to_column(., var = "dist_ocean_fact") %>% tibble() %>% 
  mutate(dist_ocean = as.double(dist_ocean_fact)) %>% 
  arrange(dist_ocean)


salsal.summarised <- salsal_med %>% group_by(dist_ocean, station) %>% summarize(max.edna = max(spec_edna_ngml, na.rm = T))

salsal_bp <- ggplot(salsal_med, aes(x = dist_ocean, y = spec_edna_ngml, group = station))+
  geom_boxplot(outlier.alpha = 0)+
  geom_text(data = salsal.summarised, aes(x = dist_ocean, y = max.edna+max.edna/2, label = salsal_groups$groups))+geom_line(data = edna_expo_ss, aes(x = rev(km), y = mean/1000), colour = "blue", inherit.aes = F)+
  geom_ribbon(data = edna_expo_ss, aes(x = rev(km), ymin = min/1000, ymax = max/1000), alpha = 0.2, inherit.aes = F)+
  geom_jitter(width = 0.5, aes(color = sampl_replicate))+
  xlab("Distance from ocean (km)")+
  ylab("eDNA conc. (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  scale_y_continuous(trans = "log10")+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
<<<<<<< HEAD
  annotate("text", x = Inf, y = Inf, label = "Atlantic Salmon", hjust = 1.1, vjust = 1.3)+
scale_x_continuous(breaks = unique(oncgor_med$dist_ocean))

salsal_bp

=======
  #geom_smooth(aes(group = 1), se = TRUE)+
  annotate("text", x = Inf, y = Inf, label = "Atlantic Salmon", hjust = 1.1, vjust = 1.3)+
 # theme(legend.position = "none")
# geom_smooth(aes(group = 1), se = TRUE, method = "gam",formula = y ~ s(x, k = 6))+
scale_x_continuous(breaks = unique(oncgor_med$dist_ocean))


salsal_bp

>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
```

### Trout
```{r}
saltru_med <- all_species_meta_median_formodel %>% dplyr::filter(species == "saltru")

<<<<<<< HEAD
# Tukey multiple comparison test, trout
=======
# Tukey multiple comparison test, pink salmon
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
saltru_aov <- aov(log10(spec_edna_ngml) ~ dist_ocean, data = saltru_med)
summary(saltru_aov)

saltru_hsd <- agricolae::HSD.test(saltru_aov, "dist_ocean", group = T)
saltru_hsd

saltru_groups <- saltru_hsd$groups %>% 
  rownames_to_column(., var = "dist_ocean_fact") %>% tibble() %>% 
  mutate(dist_ocean = as.double(dist_ocean_fact)) %>% 
  arrange(dist_ocean)


saltru.summarised <- saltru_med %>% group_by(dist_ocean, station) %>% summarize(max.edna = max(spec_edna_ngml, na.rm = T))

saltru_bp <- ggplot(saltru_med, aes(x = dist_ocean, y = spec_edna_ngml, group = station))+
  geom_boxplot(outlier.alpha = 0)+
  geom_text(data = saltru.summarised, aes(x = dist_ocean, y = max.edna+max.edna/2, label = saltru_groups$groups))+
  geom_line(data = edna_expo_st, aes(x = rev(km), y = mean/1000), colour = "blue", inherit.aes = F)+
  geom_ribbon(data = edna_expo_st, aes(x = rev(km), ymin = min/1000, ymax = max/1000), alpha = 0.2, inherit.aes = F)+
  geom_jitter(width = 0.5, aes(color = sampl_replicate))+
  xlab("Distance from ocean (km)")+
  ylab("eDNA conc. (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  scale_y_continuous(trans = "log10")+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
<<<<<<< HEAD
  annotate("text", x = Inf, y = Inf, label = "Trout", hjust = 1.1, vjust = 1.3)+
  scale_x_continuous(breaks = unique(oncgor_med$dist_ocean))
=======
  #geom_smooth(aes(group = 1), se = TRUE)+
  annotate("text", x = Inf, y = Inf, label = "Trout", hjust = 1.1, vjust = 1.3)+
  scale_x_continuous(breaks = unique(oncgor_med$dist_ocean))
 # theme(legend.position = "none")
# geom_smooth(aes(group = 1), se = TRUE, method = "gam",formula = y ~ s(x, k = 6))+
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b

saltru_bp

```

### Arctic char
```{r}
<<<<<<< HEAD
salalp_med <- all_species_meta_median_formodel %>% dplyr::filter(species == "salalp")

# Tukey multiple comparison test, Arctic char
salalp_aov <- aov(log10(spec_edna_ngml) ~ dist_ocean, data = salalp_med)
summary(salalp_aov)

salalp_hsd <- agricolae::HSD.test(salalp_aov, "dist_ocean", group = T)
salalp_hsd

=======

salalp_med <- all_species_meta_median_formodel %>% dplyr::filter(species == "salalp")

# Tukey multiple comparison test, pink salmon
salalp_aov <- aov(log10(spec_edna_ngml) ~ dist_ocean, data = salalp_med)
summary(salalp_aov)

salalp_hsd <- agricolae::HSD.test(salalp_aov, "dist_ocean", group = T)
salalp_hsd

>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
salalp_groups <- salalp_hsd$groups %>% 
  rownames_to_column(., var = "dist_ocean_fact") %>% tibble() %>% 
  mutate(dist_ocean = as.double(dist_ocean_fact)) %>% 
  arrange(dist_ocean)


salalp.summarised <- salalp_med %>% group_by(dist_ocean, station) %>% summarize(max.edna = max(spec_edna_ngml, na.rm = T))

salalp_bp <- ggplot(salalp_med, aes(x = dist_ocean, y = spec_edna_ngml, group = station))+
  geom_boxplot(outlier.alpha = 0)+
  geom_text(data = salalp.summarised, aes(x = dist_ocean, y = max.edna+max.edna/2, label = salalp_groups$groups))+
  geom_line(data = edna_unimod_sa, aes(x = rev(km), y = mean/1000), colour = "blue", inherit.aes = F)+
  geom_ribbon(data = edna_unimod_sa, aes(x = rev(km), ymin = min/1000, ymax = max/1000), alpha = 0.2, inherit.aes = F)+
  geom_jitter(width = 0.5, aes(color = sampl_replicate))+
  xlab("Distance from ocean (km)")+
  ylab("eDNA conc. (ng/mL)")+
  labs(color = "Sampling\nreplicate")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  scale_y_continuous(trans = "log10")+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))+
<<<<<<< HEAD
  annotate("text", x = Inf, y = Inf, label = "Arctic Char", hjust = 1.1, vjust = 1.3)+
  scale_x_continuous(breaks = unique(oncgor_med$dist_ocean))
=======
  #geom_smooth(aes(group = 1), se = TRUE)+
  annotate("text", x = Inf, y = Inf, label = "Arctic Char", hjust = 1.1, vjust = 1.3)+
  scale_x_continuous(breaks = unique(oncgor_med$dist_ocean))
 # theme(legend.position = "none")
# geom_smooth(aes(group = 1), se = TRUE, method = "gam",formula = y ~ s(x, k = 6))+

>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b

salalp_bp

```



# Arrange plots
```{r}
<<<<<<< HEAD
 # Make y-axis label to include with the plots with patchwork

 ednalab <- ggplot(data.frame(l = 'Species eDNA concentration in river water (ng/mL)', x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")
 
 # Organise plots of eDNA concentration together with patchwork
 bestmodpatchedna <- (ednalab | ((oncgor_bp+theme(axis.title.y = element_blank(),
                                                       axis.title.x.bottom = element_blank())) /
                                   (salsal_bp + theme(axis.title = element_blank()))/
                                   (saltru_bp + theme(axis.title = element_blank()))/
                                    (salalp_bp + theme(axis.title.y = element_blank())))) + 
  plot_layout(widths = c(1.5, 25), guides = "collect")

bestmodpatchedna[[2]] <- bestmodpatchedna[[2]] + plot_layout(tag_level = "new")

bestmodpatchedna2 <- bestmodpatchedna + plot_annotation(tag_levels = list(c("A", ""), "I"))

# Move to script hydrodyn_modeling_plotting.R to make figure with both eDNA and biomass models.

```


#Boxplot, species next to each other
=======
 
 plotlist_bp <- list(oncgor_bp +theme(axis.title.x = element_blank()),
                 salsal_bp+theme(axis.title.x = element_blank(), legend.position = "none"), 
                 saltru_bp +theme(axis.title.x = element_blank(), legend.position = "none"),
                 salalp_bp+theme(legend.position = "none"))
 
 andro_arr_bp <- ggarrange(plotlist = plotlist_bp, nrow = length(plotlist_bp), labels = LETTERS[1:4], legend = "right", align = "hv", common.legend = T)
andro_arr_bp

oncgor_bp+theme(axis.title.x = element_blank())+salsal_bp + plot_layout(nrow = 2)
 
ragg::agg_png("figures/anadromous_boxplot_arr_nosmooth.png", width = 10, height = 12, units = "in", res = 300, scaling = 1.2)
 andro_arr_bp
 dev.off()
 
 
 patchfisn <- (oncgor_bp+theme(axis.title.y = element_blank(),
                               axis.title.x.bottom = element_blank()) + 
   salsal_bp + theme(axis.title = element_blank()) +
   saltru_bp + theme(axis.title = element_blank()) +
   salalp_bp + theme(axis.title.y = element_blank())) +
   plot_layout(nrow = 4, guides = "collect")
 
 

 
 
 pylab <- ggplot(data.frame(l = 'Species eDNA concentration in river water (ng/mL)', x = 1, y = 1)) +
      geom_text(aes(x, y, label = l), angle = 90) + 
      theme_void() +
      coord_cartesian(clip = "off")

 pylab+patchfisn + plot_layout(widths = c(1, 25))
 
 
 
 bestmodpatchedna <- (pylab | ((oncgor_bp+theme(axis.title.y = element_blank(),
                                                       axis.title.x.bottom = element_blank())) /
                                   (salsal_bp + theme(axis.title = element_blank()))/
                                   (saltru_bp + theme(axis.title = element_blank()))/
                                    (salalp_bp + theme(axis.title.y = element_blank())))) + 
  plot_layout(widths = c(1.5, 25), guides = "collect")

bestmodpatchedna[[2]] <- bestmodpatchedna[[2]] + plot_layout(tag_level = "new")

bestmodpatchedna2 <- bestmodpatchedna + plot_annotation(tag_levels = list(c("A", ""), "I"))

 
 ragg::agg_png("figures/anadromous_boxplot_arr6_hydromod.png", width = 10, height = 12, units = "in", res = 300, scaling = 1.4)
 pylab+patchfisn + plot_layout(widths = c(1, 25))
 dev.off()

```
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b


#Boxplot, all species

```{r}
allfish_bp <- ggplot(all_species_meta_median_formodel, aes(x = dist_ocean, y = log10(spec_edna_ngml)))+
  geom_boxplot(aes(fill = species, group = interaction(species, station)), lwd =0.2, outlier.size = 1)+
  ylab("eDNA conc. (ng/mL)")+
  xlab("Station")+
  labs(fill = "Species")+
  scale_fill_discrete(labels = c("Pink salmon", "Atlantic salmon", "Trout", "Charr"))+
  #scale_y_continuous(trans = "log10", breaks = c(1e1, 1e2, 1e3, 1e4, 1e5, 1e6, 1e7), labels = dnalables)+
  scale_x_continuous(breaks = c(10, 13.8, 19.8, 24.1, 28.1, 32), labels = paste0("St. ", c(1:6)))+
  theme_bw()

labels_allspec <- all_species_meta_median_formodel %>% group_by(station, dist_ocean) %>%
  nest() %>%
  ungroup() %>% 
  mutate(aovv = map(.x = data, .f = ~aov(log10(.x$spec_edna_ngml) ~ .x$species))) %>%
  mutate(groupp = map(aovv, ~agricolae::HSD.test(.x, ".x$species", group = T, unbalanced = TRUE))) %>% 
  mutate(maxval = map(.x = data, .f = ~max(log10(.x$spec_edna_ngml), na.rm = T))) %>% 
  mutate(species = map(.x = groupp, .f = ~rownames(.x$groups))) %>% 
  rowwise() %>% 
  mutate(labels = list(across(groupp, ~.x$groups$groups))) %>%
  ungroup() %>% 
  select(station, dist_ocean, maxval, labels, species) %>% 
  unnest(., c(labels, maxval, species)) %>% 
  arrange(desc(dist_ocean)) %>% 
  mutate(species = factor(species, ordered = TRUE, levels = c("oncgor", "salsal", "saltru", "salalp"))) %>% 
  arrange(desc(dist_ocean), species)

xpos <- ggplot_build(allfish_bp)$data[[1]] %>% select(xmin, xmax) %>% rowwise() %>%  mutate(xlet = mean(xmin, xmax))

labels_allspec_2 <- labels_allspec %>% mutate(xlet = rev(xpos$xmax)) %>% 
  group_by(station) %>% mutate(xletok = rev(xlet)) %>% ungroup

allfish_bp_sign <- allfish_bp +
  geom_text(data = labels_allspec_2, aes(x = xletok, y = maxval+0.2, label = groupp, group = interaction(species, station)))

ragg::agg_png("figures/allfish_boxplot.png", width = 10, height = 5, units = "in", res = 300, scaling = 1.5)
 allfish_bp_sign
 dev.off()


```

# Range of eDNA concentrations for each species, and which station had min and max
```{r}
<<<<<<< HEAD
range_edna <- all_species_meta_median_formodel %>% group_by(species, station, dist_ocean) %>% 
=======
range <- all_species_meta_median_formodel %>% group_by(species, station, dist_ocean) %>% 
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
  summarise_if(is.numeric, ~median(., na.rm =T)) %>% 
 # ungroup() %>% 
  group_by(species) %>% filter(spec_edna_ngml %in% range(spec_edna_ngml, na.rm = T)) %>%
  group_by(species) %>% 
  arrange(species,spec_edna_ngml) %>% 
  ungroup() %>% 
  mutate(minmax = rep(c("min", "max"), 4)) %>% 
<<<<<<< HEAD
  mutate(eDNAconc = scientific(spec_edna_ngml)) 
=======
  mutate(eDNAconc = scientific(spec_edna_ngml, 2)) 

range_statsj <- range %>% 
  pivot_wider(., id_cols = c(species, station), names_from = minmax, values_from = eDNAconc)

range_statsj
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b

range_stations <- range_edna %>% 
  pivot_wider(., id_cols = c(species, station), names_from = minmax, values_from = eDNAconc)

writexl::write_xlsx(range_statsj, here("range_ednaconc_stations.xlsx"))

<<<<<<< HEAD
# Fold-change difference along the river for each species
range_spec <- range_edna %>% 
=======
range_spec <- range %>% 
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
  pivot_wider(., id_cols = c(species), names_from = minmax, values_from = spec_edna_ngml) %>% 
  mutate(magnitudechange = log10(max/min))

range_spec

<<<<<<< HEAD
# How much change from one station to the next (upstream)?
=======
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
between_stat <- all_species_meta_median_formodel %>% group_by(species, station, dist_ocean) %>% 
  summarise_if(is.numeric, ~median(., na.rm =T))

changedata <- between_stat %>% pivot_wider(., id_cols = species, names_from = station, values_from = spec_edna_ngml, names_prefix = "stat") %>%
  mutate(st1_2 = log10((stat2)/stat1)) %>% 
  mutate(st2_3 = log10(stat3/stat2)) %>% 
  mutate(st3_4 = log10(stat4/stat3)) %>% 
  mutate(st4_5 = log10(stat5/stat4)) %>% 
  mutate(st5_6 = log10(stat6/stat5)) %>% 
  dplyr::select(-starts_with("stat")) %>% 
  pivot_longer(., cols = -species, names_to = "statcomp", values_to = "change")

changedata2 <- between_stat %>% pivot_wider(., id_cols = species, names_from = station, values_from = spec_edna_ngml, names_prefix = "stat") %>%
  mutate(st1_2 = -((stat1-stat2)/stat1)) %>% 
  mutate(st2_3 = -((stat2-stat3)/stat2)) %>% 
  mutate(st3_4 = -((stat3-stat4)/stat3)) %>% 
  mutate(st4_5 = -((stat4-stat5)/stat4)) %>% 
  mutate(st5_6 = -((stat5-stat6)/stat5)) %>% 
  dplyr::select(-starts_with("stat")) %>% 
  pivot_longer(., cols = -species, names_to = "statcomp", values_to = "change") %>% 
  mutate(Sign = sign(change)) %>% 
  mutate(change_plusminus = case_when(change >= 0 ~ change+1,
                            change < 0 ~ change-1))
  
  fishcols <- ggplot_build(allfish_bp)$data[[1]] %>% select(fill) %>% unique()
  
  # Some experimental plots
  stat_compareplot <- ggplot(changedata, aes(x = statcomp, y = 2+change, fill = species))+
  geom_bar(stat = "identity", position = "dodge")+
  scale_y_continuous(breaks = c(log10(0.05), log10(0.1), log10(0.5), 0, log10(5), 1, log10(20))+2, labels = c(0.05, 0.1, 0.5, 1, 5, 10, 20))+
  scale_x_discrete(labels = c("1 vs 2", "2 vs 3", "3 vs 4", "4 vs 5", "5 vs 6"))+
  labs(y = "Ratio of eDNA concentration", x = "Compared stations")+
  geom_hline(yintercept = 2)+
  scale_fill_manual(values = fishcols$fill, labels = c("Pink salmon", "Atlantic salmon", "Trout", "Charr"))+
  theme_classic()+
  labs(fill = "Species")

stat_compareplot2 <- ggplot(changedata2, aes(x = statcomp, y = log10(abs(change_plusminus))*Sign, fill = species))+
  geom_bar(stat = "identity", position = "dodge")+
  scale_y_continuous(breaks = c(-log10(1.9), -log10(1.5), log10(1), log10(2), log10(6), log10(11), log10(21)), labels = c(-0.9, -0.5, 0,2, 5, 10, 20))+
  scale_x_discrete(labels = c("1 vs 2", "2 vs 3", "3 vs 4", "4 vs 5", "5 vs 6"))+
  labs(y = "Relative change in eDNA concentration", x = "Compared stations")+
  scale_fill_manual(values = fishcols$fill, labels = c("Pink salmon", "Atlantic salmon", "Trout", "Charr"))+
  theme_classic()+
  labs(fill = "Species")
  
  stat_compareplot2

ragg::agg_png("figures/compare_stations2.png", width = 10, height = 5, units = "in", res = 300, scaling = 1.5)
 stat_compareplot2
 dev.off()

```


<<<<<<< HEAD
# Shedding rates in ng/kg/min
Calculated as ((ng/mL)x1000mL/L x 1460L/s x 60s/min)/(number of fish * avg. weight in kg)  
```{r}
#Average weight of each species - c.f., Table 1 in the manuscript, data obtained from Statistics Norway (https://www.ssb.no/statbank/table/08991)


=======
#### Shedding rates in ng/kg/min
Calculated as ((ng/mL)x1000mL/L x 1460L/s x 60s/min)/(number of fish * avg. weight in kg)  
```{r}


all_species_meta_median_formodel %>% group_by(species, station) %>% summarise_if(is.numeric, mean) %>% dplyr::filter(station == "1")

oncgor_shed = ((0.0236 * 1000)*1460*60)/(2800*1.7)
oncgor_shed

salsal_shed = ((3.333e-5 * 1000)*1460*60)/(9 * 2.3)
salsal_shed

saltru_shed = ((2.147e-5 * 1000)*1460*60)/(3 * 1.0)
saltru_shed

>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
shed_rates <- all_species_meta_median_formodel %>% 
  dplyr::filter(station == "1") %>% 
  mutate(shed = case_when(species == "oncgor" ~ ((spec_edna_ngml * 1000)*1460*60)/(2800*1.7),
                          species == "salsal" ~ ((spec_edna_ngml * 1000)*1460*60)/(9*2.3),
                          species == "saltru" ~ ((spec_edna_ngml * 1000)*1460*60)/(3*1.0),
                          species == "salalp" ~ ((spec_edna_ngml * 1000)*1460*60)/(1*0.5)))

<<<<<<< HEAD
shed_rates_median <- shed_rates %>% 
  group_by(species, sampl_replicate) %>%
  summarise(median_shed = median(shed))
  
shed_rates_median %>% group_by(species) %>% summarise(range = range(median_shed))

# Median "estimated shedding rate" for each sample replicate
writexl::write_xlsx(shed_rates_median, here("data", "shed_rates_median.xlsx"))

#Sassoubre et al. 2016 shedding rate for Pacific sardine in pg/h/g transformed to ng/kg/min: (pg/h/g) -> pg/60min/h * 1000g/kg 
(3368e-12/60)*1000 # = 5.61e-8g = 56.1 ng

=======


salalp_shed = ((5.23e-7 * 1000)*1460*60)/(1 * 0.5)
salalp_shed

#Sassoubre et al. shedding rate: (pg/h/g) -> pg/60min/h * 1000g/kg 
(3368e-12/60)*1000 # = 5.61e-8g = 56.1 ng
>>>>>>> 7223e132aa3d391884ae14d7dcfe7595d831bb4b
```

