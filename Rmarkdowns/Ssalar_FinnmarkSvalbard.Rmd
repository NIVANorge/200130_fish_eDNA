---
title: "Ssalar_FinnmarkSvalbard"
author: "EEG"
date: "22 11 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.
```{r, echo=FALSE}
library(here)
library(readr)
library(magrittr)
library(dplyr)
library(ggplot2)
library(cowplot)
library(ggpubr)
library(gridExtra)
```


```{r}
quant_ssalar_finsval1 <- read_delim(here("data", "EEG_2021-11-19_Ssalar_FinmSvalb_2samp3repsCFX96_054.txt")) %>% 
  mutate(plate = rep("plate1", dim(.)[1])) %>% 
  dplyr::filter(Sample %in% as.character(c(567,568,570,571,573,574,576,577,579,580,582,583,586,587,589,590,592,593))) %>% 
  arrange(desc(Sample)) %>%
  dplyr::mutate(tech_rep = factor(rep(c(1:3), 18)))

quant_ssalar_finsval2 <- read_delim(here("data", "EEG_2021-11-24_Ssalar_svalfinnm_plate2_CFX96_054.txt")) %>% 
  mutate(plate = rep("plate2", dim(.)[1])) %>% 
  dplyr::filter(Sample %in% as.character(c(569,572,575,578,581,584,588,591,594))) %>% 
  arrange(desc(Sample)) %>%
  dplyr::mutate(tech_rep = factor(rep(c(1:3), 9)))

quant_ssalar_finsval0 <- rbind(quant_ssalar_finsval1, quant_ssalar_finsval2)

quant_ssalar_finsval <- quant_ssalar_finsval0 %>% mutate(detect = ifelse(SQ == "NaN", 0, 1))

 
samples <- readxl::read_xlsx(here("data", "eDNAsamples_2021.xlsx")) %>%
  janitor::clean_names(.) %>% 
  mutate(across(extraction_date, ~ as.Date(as.character(.), format = '%Y-%m-%d'))) %>%
  mutate(provetatt2 = as.character(provetatt)) %>%
  mutate(across(provetatt, ~ as.Date(as.character(.), format = '%d.%m.%Y'))) %>%
  mutate(across(volum, ~as.numeric(.))) %>% 
  mutate(qbit1 = as.numeric(dna_ng_m_l_qubit_read1)) %>% 
  mutate(qbit2 = as.numeric(dna_ng_m_l_qubit_read2)) %>% 
  mutate(qbit_avg = (qbit1+qbit2)/2) %>% 
  mutate(ngDNA_filt_volenhet = ((150*qbit_avg)/volum)) %>% 
  mutate(tot_ngDNA = 150*qbit_avg) %>% mutate(dybde = as.numeric(dybde)) %>% 
  rename(dyp = dybde)
  

```

```{r}
quant_ssalar_finsval_join <- quant_ssalar_finsval %>% dplyr::select(Content, Sample, Cq, SQ, plate, detect, tech_rep) %>%  dplyr::mutate(SQ = as.numeric(SQ)) %>% 
  dplyr::arrange(desc(Sample)) %>% dplyr::mutate(Sample = factor(Sample)) %>% 
left_join(., samples, by = c("Sample" = "provenr")) %>% mutate(SQ_vol = SQ/volum) %>% 
  mutate(stasjon = factor(as.character(stasjon), ordered = T, levels = c("4","3","2","1","5","6", "TV", "BT", "LS")))
#View(quant_samples)

nrep <- quant_ssalar_finsval_join %>% dplyr::group_by(Sample, sample_rep, stasjon) %>% count()
ndetect <- quant_ssalar_finsval_join %>% dplyr::group_by(Sample, sample_rep, stasjon) %>% summarise(num_detect = sum(detect))

nrepdet <- left_join(nrep, ndetect, by = "Sample") %>% dplyr::select(-sample_rep.y, -stasjon.y) %>% rename(stasjon = stasjon.x, sample_rep = sample_rep.x)

stasj_dist <- read_delim(here("data", "stasj_havdist_GJE.txt"), delim = "\t") %>% mutate(stasjon = factor(as.character(stasjon), ordered = T, levels = c("4","3","2","1","5","6", "TV", "BT", "LS")))


stasj_dist <- read_delim(here("data", "stasj_lat_lon4.txt"), delim = "\t") %>% dplyr::filter(fylke %in% c("Finnmark", "Svalbard")) %>% 
  mutate(stasjon = factor(as.character(stasjon), ordered = T, levels = c("4","3","2","1","5","6", "TV", "BT", "LS")))

eDNAconc_ssalar_finnsval <- left_join(quant_ssalar_finsval_join, stasj_dist, by = c("innsjo" = "innsjo", "stasjon" = "stasjon", "dyp" = "dyp")) %>% dplyr::select(Sample, Cq, SQ, sample_rep, tech_rep, dyp, stasjon, innsjo, fylke.y, volum, SQ_vol, lat, lon, provetatt, dist_hav) %>% rename(fylke = "fylke.y")

write_delim(eDNAconc_ssalar_finnsval, "eDNAconc_ssalar_finnsval.txt", delim = "\t")

#### calculate median concentration ####
medeDNAconc_ssalar <- eDNAconc_ssalar_finnsval %>%  group_by(lat, lon, stasjon, fylke) %>% summarise_if(is.numeric, ~median(., na.rm = T))

medeDNAconc_ssalar[is.na(medeDNAconc_ssalar)] <- 0


#### Langs grense jakobselv, kart ####
medeDNAconc_ssalar_finn <- eDNAconc_ssalar_finnsval %>% dplyr::filter(fylke == "Finnmark")


medeDNAconc_ssalar_finn_map <- leaflet(medeDNAconc_ssalar_finn) %>% 
    addTiles() %>% 
     fitBounds(~min(lon, na.rm = TRUE), ~min(lat, na.rm = TRUE), ~max(lon, na.rm = TRUE), ~max(lat, na.rm = TRUE)+0.04) %>% 
  addCircleMarkers(color = "red", radius = ~log(SQ_vol*1e11, base = 10)) #%>% 
  # addLabelOnlyMarkers(label = ~as.character(stasjon), labelOptions = labelOptions(noHide = T, direction = 'left', textOnly = T, textsize = "20px"))

mapshot(medeDNAconc_ssalar_finn_map, file = "eDNAconc_ssalar_finn_map.png")

sqvol_disthav <- eDNAconc_ssalar_finnsval %>% filter(fylke == "Finnmark") %>% group_by(dist_hav) %>% summarise_if(is.numeric, ~mean(., na.rm =T))
summary(lm(log(SQ_vol) ~ dist_hav, data = sqvol_disthav))
  
ssalar_finn_forplot2 <- left_join(quant_ssalar_finsval_join, stasj_dist, by = "stasjon")

nrepdet_forplot <- left_join(nrepdet, stasj_dist, by = "stasjon") %>% mutate(fraction = stringr::str_c(num_detect, n, sep = "/")) %>% ungroup() %>% dplyr::select(sample_rep, stasjon, fraction)

nrepdet_forplot_finn <- nrepdet_forplot %>% pivot_wider(names_from = stasjon, values_from = fraction) %>% dplyr::select(`4`, `3`, `2`, `1`, `5`, `6`)

nrepdet_forplot_sval <- nrepdet_forplot %>% pivot_wider(names_from = stasjon, values_from = fraction) %>% dplyr::select(BT, LS, TV)
```

```{r}
ssalar_finsval_plot <- ggplot(data = quant_ssalar_finsval_join, aes(x = factor(stasjon, ordered = T, levels =   c("4","3","2","1","5","6", "TV", "BT", "LS")), y = SQ_vol, color = sample_rep, text = Sample))+
  geom_jitter(width = 0.1, size = 1.5)+
  xlab("Stasjon")+
  ylab("Ishavsrøye eDNA (ng/mL)")+
  labs(color = "Prøvetakings-\nreplikat")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  facet_grid(cols = vars(fylke), space = "free_x", scales = "free_x", labeller = as_labeller(c("Finnmark" = "Finnmark - Grense Jakobselv", "Svalbard" = "Svalbard")))+
  theme_bw()+
  #scale_x_discrete()
  scale_y_continuous(trans = "log10")#+
  #ylim(0.5e-07, 1e-05)
ssalar_finsval_plot

#### distance from ocean, Grense Jakobselv ####
ssalar_finn_plt2 <- ggplot(data = ssalar_finn_forplot2, aes(x = dist_hav, y = SQ_vol, color = sample_rep))+
  geom_jitter(width = 0.1, size = 1.5)+
  xlab("Distanse fra havet (km)")+
  ylab("Atlantisk laks eDNA (ng/mL)")+
  labs(color = "Prøvetakings-\nreplikat", title = "Grense Jakobselv")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  scale_y_continuous(trans = "log10", limits = c(1e-9,5e-3), breaks = c(1e-3, 1e-4, 1e-5, 1e-6, 1e-7, 1e-8, 1e-9))+
  theme_bw()+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, size = 12))
ssalar_finn_plt2

ssalar_sval_plt <- ggplot(data = quant_ssalar_finsval_join %>% dplyr::filter(fylke == "Svalbard"), aes(x = stasjon, y = SQ_vol, color = sample_rep))+
  geom_jitter(width = 0.1, size = 1.5)+
  xlab("Stasjon")+
  ylab("Atlantisk laks eDNA (ng/mL)")+
  labs(color = "Prøvetakings-\nreplikat")+
  scale_color_manual(values = c("red", "blue", "cyan"))+
  scale_y_continuous(trans = "log10", limits = c(1e-9,5e-3), breaks = c(1e-3, 1e-4, 1e-5, 1e-6, 1e-7, 1e-8, 1e-9), labels = NULL)+
  theme_bw()+
  labs(title = "Svalbard")+
  theme(axis.title = element_text(size = 10),
        legend.title = element_text(size = 10),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 12))
ssalar_sval_plt

png(filename = "atlsal_finmark_svalbard_hires.png", width = 2300, height = 1000,
    units = "px", pointsize = 8, bg = "white", res = 300,
    restoreConsole = TRUE)
ggarrange(ssalar_finn_plt2, ssalar_sval_plt, common.legend = TRUE, widths = c(2,1))
dev.off()



```
